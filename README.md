# SR Linux EVPN Multi Homing

Baseline setup to play with EVPN multi homing (client 2), some terminology:

ES - Ethernet Segment

ESI - Ethernet Segment Identifier (zero means single homed CE)

DF - Designated forwarder, in an all active is the device that forwards BUM traffic from the network into the host

# Overlay, underlay and mgmt 

![pic1](https://github.com/missoso/srl-mh-evpn/blob/main/img_and_drawio/underlay_overlay_mgmt.drawio.png)

# Client baseline setup

![pic2](https://github.com/missoso/srl-mh-evpn/blob/main/img_and_drawio/srl-mh-evpn-detail.png)

Symmetric routing on the ip-vrf-12

# Ethernet segment - Client2 multi homed

DF election results as seen in leaf2 (10.0.1.1 is leaf1)

```bash
A:leaf2# show system network-instance ethernet-segments ES-Client-2
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
ES-Client-2 is up, all-active
  ESI      : 00:24:24:24:24:24:24:00:00:01
  Alg      : default
  Peers    : 10.0.1.1
  Interface: lag2
  Next-hop : N/A
  evi      : N/A
  Network-instances:
     vrf-2
      Candidates : 10.0.1.1 (DF), 10.0.1.2
      Interface : lag2.2
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Summary
 1 Ethernet Segments Up
 0 Ethernet Segments Down
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
```

Leaf1 is elected as the DF

# How client 2 Ethernet bond address is learnt

```bash
[*]─[client2]─[/]
└──> ifconfig | grep bond0
bond0     Link encap:Ethernet  HWaddr AA:C1:AB:59:EE:FF  
```

Leaf1 - Locally learnt (last row)


```bash
A:leaf1# show network-instance vrf-2 bridge-table mac-table all
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Mac-table of network instance vrf-2
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
+--------------------+--------------------------------------------------------+------------+-----------------+---------+--------+--------------------------------------------------------+
|      Address       |                      Destination                       | Dest Index |      Type       | Active  | Aging  |                      Last Update                       |
+====================+========================================================+============+=================+=========+========+========================================================+
| 00:00:5E:00:01:01  | irb-interface                                          | 0          | irb-interface-  | true    | N/A    | 2025-11-07T12:48:55.000Z                               |
|                    |                                                        |            | anycast         |         |        |                                                        |
| 1A:8D:07:FF:00:42  | vxlan-interface:vxlan1.2 vtep:10.0.1.4 vni:2           | 9558729792 | evpn-static     | true    | N/A    | 2025-11-07T12:49:33.000Z                               |
| 1A:E7:04:FF:00:42  | irb-interface                                          | 0          | irb-interface   | true    | N/A    | 2025-11-07T12:48:55.000Z                               |
| 1A:F4:05:FF:00:42  | vxlan-interface:vxlan1.2 vtep:10.0.1.2 vni:2           | 9558729798 | evpn-static     | true    | N/A    | 2025-11-07T12:49:34.000Z                               |
| AA:C1:AB:31:6D:D7  | vxlan-interface:vxlan1.2 vtep:10.0.1.4 vni:2           | 9558729792 | evpn            | true    | N/A    | 2025-11-10T09:55:26.000Z                               |
| AA:C1:AB:59:EE:FF  | lag2.2                                                 | 9          | learnt          | true    | 226    | 2025-11-10T09:54:51.000Z                               |
+--------------------+--------------------------------------------------------+------------+-----------------+---------+--------+--------------------------------------------------------+
```

Leaf2 - EVPN learnt (last row)


```bash
A:leaf2# show network-instance vrf-2 bridge-table mac-table all
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Mac-table of network instance vrf-2
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
+--------------------+--------------------------------------------------------+------------+-----------------+---------+--------+--------------------------------------------------------+
|      Address       |                      Destination                       | Dest Index |      Type       | Active  | Aging  |                      Last Update                       |
+====================+========================================================+============+=================+=========+========+========================================================+
| 00:00:5E:00:01:01  | irb-interface                                          | 0          | irb-interface-  | true    | N/A    | 2025-11-07T12:48:55.000Z                               |
|                    |                                                        |            | anycast         |         |        |                                                        |
| 1A:8D:07:FF:00:42  | vxlan-interface:vxlan1.2 vtep:10.0.1.4 vni:2           | 9558694253 | evpn-static     | true    | N/A    | 2025-11-07T12:49:33.000Z                               |
| 1A:E7:04:FF:00:42  | vxlan-interface:vxlan1.2 vtep:10.0.1.1 vni:2           | 9558694259 | evpn-static     | true    | N/A    | 2025-11-07T12:49:34.000Z                               |
| 1A:F4:05:FF:00:42  | irb-interface                                          | 0          | irb-interface   | true    | N/A    | 2025-11-07T12:48:55.000Z                               |
| AA:C1:AB:31:6D:D7  | vxlan-interface:vxlan1.2 vtep:10.0.1.4 vni:2           | 9558694253 | evpn            | true    | N/A    | 2025-11-10T09:55:26.000Z                               |
| AA:C1:AB:59:EE:FF  | lag2.2                                                 | 5          | evpn            | true    | N/A    | 2025-11-10T09:00:49.000Z                               |
+--------------------+--------------------------------------------------------+------------+-----------------+---------+--------+--------------------------------------------------------+
```

# Type 1 routes 

Leaf1 and leaf2 announce two type 1 routes (output below is from leaf2 towards the RR - 10.0.2.1)

1 - Auto Discovery per ES: multi-homing mode, fast convergence (mass withdrawal)

2 - Auto Discovery per EVPN instance (tag ID is zero): Reachability for the ES, remote PE's will send traffic to a destination ES instead of a destination MAC (aka aliasing)

Routes announced by leaf2:


```bash
--{ running }--[  ]--
A:leaf2# show network-instance default protocols bgp neighbor 10.0.2.1 advertised-routes evpn
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Peer        : 10.0.2.1, remote AS: 100, local AS: 100
Type        : static
Description : None
Group       : iBGP-overlay
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Origin codes: i=IGP, e=EGP, ?=incomplete
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Type 1 Ethernet Auto-Discovery Routes
+----------------------------------+--------------------------------+------------+----------------------------------+----------------------------------+---------+----------------------------------+
|       Route-distinguisher        |              ESI               |   Tag-ID   |             Next-Hop             |               MED                | LocPref |               Path               |
+==================================+================================+============+==================================+==================================+=========+==================================+
| 10.0.1.2:2                       | 00:24:24:24:24:24:24:00:00:01  | 0          | 10.0.1.2                         | -                                | 100     |                                  |
| 10.0.1.2:2                       | 00:24:24:24:24:24:24:00:00:01  | 4294967295 | 10.0.1.2                         | -                                | 100     |                                  |
+----------------------------------+--------------------------------+------------+----------------------------------+----------------------------------+---------+----------------------------------+
[...]]
```

All PE's that have clients in this MAC VRF will receive these routes, example on leaf4 (route via iGBP RR)

```bash
--{ running }--[  ]--
A:leaf4# show network-instance default protocols bgp neighbor 10.0.2.1 received-routes evpn
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Peer        : 10.0.2.1, remote AS: 100, local AS: 100
Type        : static
Description : None
Group       : iBGP-overlay
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Status codes: u=used, *=valid, >=best, x=stale, b=backup
Origin codes: i=IGP, e=EGP, ?=incomplete
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Type 1 Ethernet Auto-Discovery Routes
+--------+--------------------------------+--------------------------------+------------+--------------------------------+--------------------------------+---------+--------------------------------+
| Status |      Route-distinguisher       |              ESI               |   Tag-ID   |            Next-Hop            |              MED               | LocPref |              Path              |
+========+================================+================================+============+================================+================================+=========+================================+
| u*>    | 10.0.1.1:2                     | 00:24:24:24:24:24:24:00:00:01  | 0          | 10.0.1.1                       | -                              | 100     |                                |
| u*>    | 10.0.1.1:2                     | 00:24:24:24:24:24:24:00:00:01  | 4294967295 | 10.0.1.1                       | -                              | 100     |                                |
| u*>    | 10.0.1.2:2                     | 00:24:24:24:24:24:24:00:00:01  | 0          | 10.0.1.2                       | -                              | 100     |                                |
| u*>    | 10.0.1.2:2                     | 00:24:24:24:24:24:24:00:00:01  | 4294967295 | 10.0.1.2                       | -                              | 100     |                                |
+--------+--------------------------------+--------------------------------+------------+--------------------------------+--------------------------------+---------+--------------------------------+
```

# Aliasing - client2

Leaf4 will receive routes type two from leaf1 and routes type one from both leaf1 and leaf2 

Client2 Ethernet bond address: AA:C1:AB:59:EE:FF

Leaf1 RID : 10.0.1.1

Leaf2 RID : 10.0.1.2

```bash
--{ running }--[  ]--
A:leaf4# show network-instance default protocols bgp neighbor 10.0.2.1 received-routes evpn
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Peer        : 10.0.2.1, remote AS: 100, local AS: 100
Type        : static
Description : None
Group       : iBGP-overlay
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Status codes: u=used, *=valid, >=best, x=stale, b=backup
Origin codes: i=IGP, e=EGP, ?=incomplete
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Type 1 Ethernet Auto-Discovery Routes
+--------+--------------------------------+--------------------------------+------------+--------------------------------+--------------------------------+---------+--------------------------------+
| Status |      Route-distinguisher       |              ESI               |   Tag-ID   |            Next-Hop            |              MED               | LocPref |              Path              |
+========+================================+================================+============+================================+================================+=========+================================+
| u*>    | 10.0.1.1:2                     | 00:24:24:24:24:24:24:00:00:01  | 0          | 10.0.1.1                       | -                              | 100     |                                |
| u*>    | 10.0.1.1:2                     | 00:24:24:24:24:24:24:00:00:01  | 4294967295 | 10.0.1.1                       | -                              | 100     |                                |
| u*>    | 10.0.1.2:2                     | 00:24:24:24:24:24:24:00:00:01  | 0          | 10.0.1.2                       | -                              | 100     |                                |
| u*>    | 10.0.1.2:2                     | 00:24:24:24:24:24:24:00:00:01  | 4294967295 | 10.0.1.2                       | -                              | 100     |                                |
+--------+--------------------------------+--------------------------------+------------+--------------------------------+--------------------------------+---------+--------------------------------+
Type 2 MAC-IP Advertisement Routes
+--------+----------------------------+------------+-------------------+----------------------------+----------------------------+----------------------------+---------+----------------------------+
| Status |    Route-distinguisher     |   Tag-ID   |    MAC-address    |         IP-address         |          Next-Hop          |            MED             | LocPref |            Path            |
+========+============================+============+===================+============================+============================+============================+=========+============================+
| u*>    | 10.0.1.1:2                 | 0          | 00:00:5E:00:01:01 | 172.17.2.254               | 10.0.1.1                   | -                          | 100     |                            |
| u*>    | 10.0.1.1:2                 | 0          | 1A:E7:04:FF:00:42 | 0.0.0.0                    | 10.0.1.1                   | -                          | 100     |                            |
| u*>    | 10.0.1.1:2                 | 0          | AA:C1:AB:59:EE:FF | 0.0.0.0                    | 10.0.1.1                   | -                          | 100     |                            |
| u*>    | 10.0.1.1:2                 | 0          | AA:C1:AB:59:EE:FF | 172.17.2.2                 | 10.0.1.1                   | -                          | 100     |                            |
| u*>    | 10.0.1.2:2                 | 0          | 00:00:5E:00:01:01 | 172.17.2.254               | 10.0.1.2                   | -                          | 100     |                            |
| u*>    | 10.0.1.2:2                 | 0          | 1A:F4:05:FF:00:42 | 0.0.0.0                    | 10.0.1.2                   | -                          | 100     |                            |
+--------+----------------------------+------------+-------------------+----------------------------+----------------------------+----------------------------+---------+----------------------------+
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
```

In the vrf-2 mac-table the Client2 Ethernet bond address is reachable via destination vxlan1.2 plus the ESI address (different from a single homed host which would have been vxlan1.2 plus the VTEP plus the VNI).

Client2 Ethernet bond address AA:C1:AB:59:EE:FF

ESI 00:24:24:24:24:24:24:00:00:01


```bash
A:leaf4# show network-instance vrf-2 bridge-table mac-table all
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Mac-table of network instance vrf-2
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
+--------------------+--------------------------------------------------------+------------+-----------------+---------+--------+--------------------------------------------------------+
|      Address       |                      Destination                       | Dest Index |      Type       | Active  | Aging  |                      Last Update                       |
+====================+========================================================+============+=================+=========+========+========================================================+
| 00:00:5E:00:01:01  | irb-interface                                          | 0          | irb-interface-  | true    | N/A    | 2025-11-07T12:48:50.000Z                               |
|                    |                                                        |            | anycast         |         |        |                                                        |
| 1A:8D:07:FF:00:42  | irb-interface                                          | 0          | irb-interface   | true    | N/A    | 2025-11-07T12:48:50.000Z                               |
| 1A:E7:04:FF:00:42  | vxlan-interface:vxlan1.2 vtep:10.0.1.1 vni:2           | 9558682562 | evpn-static     | true    | N/A    | 2025-11-07T12:49:33.000Z                               |
| 1A:F4:05:FF:00:42  | vxlan-interface:vxlan1.2 vtep:10.0.1.2 vni:2           | 9558682566 | evpn-static     | true    | N/A    | 2025-11-07T12:49:34.000Z                               |
| AA:C1:AB:31:6D:D7  | ethernet-1/1.0                                         | 2          | learnt          | true    | 207    | 2025-11-10T10:55:27.000Z                               |
| AA:C1:AB:59:EE:FF  | vxlan-interface:vxlan1.2                               | 9558682699 | evpn            | true    | N/A    | 2025-11-10T09:00:49.000Z                               |
|                    | esi:00:24:24:24:24:24:24:00:00:01                      |            |                 |         |        |                                                        |
+--------------------+--------------------------------------------------------+------------+-----------------+---------+--------+--------------------------------------------------------+
Total Irb Macs                 :    1 Total    1 Active
Total Static Macs              :    0 Total    0 Active
Total Duplicate Macs           :    0 Total    0 Active
Total Learnt Macs              :    1 Total    1 Active
Total Evpn Macs                :    1 Total    1 Active
Total Evpn static Macs         :    2 Total    2 Active
Total Irb anycast Macs         :    1 Total    1 Active
Total Proxy Antispoof Macs     :    0 Total    0 Active
Total Reserved Macs            :    0 Total    0 Active
Total Eth-cfm Macs             :    0 Total    0 Active
Total Irb Vrrps                :    0 Total    0 Active
```

And that ESI (esi:00:24:24:24:24:24:24:00:00:01 ) can be reached via two VTEP's, leaf1 (10.0.1.1) and leaf2 (10.0.1.2):

```bash
A:leaf4# show tunnel-interface vxlan1 vxlan-interface 2 bridge-table unicast-destinations destination *
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Show report for vxlan-interface vxlan1.2 unicast destinations
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Destinations
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
+--------------+------------+-------------------+-----------------------------+
| VTEP Address | Egress VNI | Destination-index | Number MACs (Active/Failed) |
+==============+============+===================+=============================+
| 10.0.1.1     | 2          | 34900181389       | 1(1/0)                      |
| 10.0.1.2     | 2          | 34900181395       | 1(1/0)                      |
+--------------+------------+-------------------+-----------------------------+
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Ethernet Segment Destinations
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
+-------------------------------+-------------------+--------------------+-----------------------------+
|              ESI              | Destination-index |       VTEPs        | Number MACs (Active/Failed) |
+===============================+===================+====================+=============================+
| 00:24:24:24:24:24:24:00:00:01 | 34900181396       | 10.0.1.1, 10.0.1.2 | 1(1/0)                      |
+-------------------------------+-------------------+--------------------+-----------------------------+
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Summary
  3 unicast-destinations, 2 non-es, 1 es
  3 MAC addresses, 3 active, 0 non-active
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

```


The above allows leaf4 to load balance unicast traffic

# Type 4 routes 

Leaf1 and leaf2 announce one type 4 route (output below is from leaf2) to allow for the DF election and local bias filtering (block BUM traffic being sent to the originating ES).

Route announced by leaf2 (10.0.2.1 is one of the RR's)

```bash
--{ running }--[  ]--
A:leaf2# show network-instance default protocols bgp neighbor 10.0.2.1 advertised-routes evpn
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Peer        : 10.0.2.1, remote AS: 100, local AS: 100
Type        : static
Description : None
Group       : iBGP-overlay
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Origin codes: i=IGP, e=EGP, ?=incomplete
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
[...]
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Type 4 Ethernet Segment Routes
+-----------------------------+--------------------------------+-----------------------------+-----------------------------+-----------------------------+---------+-----------------------------+
|     Route-distinguisher     |              ESI               |       Originating-IP        |          Next-Hop           |             MED             | LocPref |            Path             |
+=============================+================================+=============================+=============================+=============================+=========+=============================+
| 10.0.1.2:0                  | 00:24:24:24:24:24:24:00:00:01  | 10.0.1.2                    | 10.0.1.2                    | -                           | 100     |                             |
+-----------------------------+--------------------------------+-----------------------------+-----------------------------+-----------------------------+---------+-----------------------------+
[...]
```

Only PE's that are connected to the same Ethernet Segment will import these routes

## Deploying the lab

The lab is deployed with the [containerlab](https://containerlab.dev) project, where [`symmetric.clab.yml`](https://github.com/missoso/srl-symmetric-routing-irb/blob/main/symmetric.clab.yml) file declaratively describes the lab topology.

```bash
# change into the cloned directory
# and execute
containerlab deploy --reconfigure
```

To remove the lab:

```bash
containerlab destroy --cleanup
```

## Access the lab

Leaf/spines: SSH through their management IP address or their hostname as defined in the topology file.

```bash
# reach a SR Linux leaf or a spine via SSH
ssh admin@leaf1
ssh admin@spine1
```
Linux clients cannot be reached via SSH, as it is not enabled, but it is possible to connect to them with a docker exec command.

```bash
# reach a Linux client via Docker
docker exec -it client1 bash
```

```bash
╭─────────┬────────────────────────────────────┬─────────┬────────────────╮
│   Name  │             Kind/Image             │  State  │ IPv4/6 Address │
├─────────┼────────────────────────────────────┼─────────┼────────────────┤
│ client1 │ linux                              │ running │ 172.80.80.31   │
│         │ ghcr.io/srl-labs/network-multitool │         │ N/A            │
├─────────┼────────────────────────────────────┼─────────┼────────────────┤
│ client2 │ linux                              │ running │ 172.80.80.32   │
│         │ ghcr.io/srl-labs/network-multitool │         │ N/A            │
├─────────┼────────────────────────────────────┼─────────┼────────────────┤
│ client3 │ linux                              │ running │ 172.80.80.33   │
│         │ ghcr.io/srl-labs/network-multitool │         │ N/A            │
├─────────┼────────────────────────────────────┼─────────┼────────────────┤
│ client4 │ linux                              │ running │ 172.80.80.34   │
│         │ ghcr.io/srl-labs/network-multitool │         │ N/A            │
├─────────┼────────────────────────────────────┼─────────┼────────────────┤
│ leaf1   │ nokia_srlinux                      │ running │ 172.80.80.11   │
│         │ ghcr.io/nokia/srlinux:24.10.1      │         │ N/A            │
├─────────┼────────────────────────────────────┼─────────┼────────────────┤
│ leaf2   │ nokia_srlinux                      │ running │ 172.80.80.12   │
│         │ ghcr.io/nokia/srlinux:24.10.1      │         │ N/A            │
├─────────┼────────────────────────────────────┼─────────┼────────────────┤
│ leaf3   │ nokia_srlinux                      │ running │ 172.80.80.13   │
│         │ ghcr.io/nokia/srlinux:24.10.1      │         │ N/A            │
├─────────┼────────────────────────────────────┼─────────┼────────────────┤
│ leaf4   │ nokia_srlinux                      │ running │ 172.80.80.14   │
│         │ ghcr.io/nokia/srlinux:24.10.1      │         │ N/A            │
├─────────┼────────────────────────────────────┼─────────┼────────────────┤
│ spine1  │ nokia_srlinux                      │ running │ 172.80.80.21   │
│         │ ghcr.io/nokia/srlinux:24.10.1      │         │ N/A            │
├─────────┼────────────────────────────────────┼─────────┼────────────────┤
│ spine2  │ nokia_srlinux                      │ running │ 172.80.80.22   │
│         │ ghcr.io/nokia/srlinux:24.10.1      │         │ N/A            │
╰─────────┴────────────────────────────────────┴─────────┴────────────────╯
```
